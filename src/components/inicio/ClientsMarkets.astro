---
const {
  title = "Empresas con las que trabajamos",
  subtitle = "Alianzas activas y colaboraciones anteriores",
  bg = "navy",           // "white" | "navy"
  speedSeconds = 15,      // más bajo = más rápido (p.ej. 25)
  logos = [
    "/logos/ALD-Automative.png",
    "/logos/APIA.png",
    "/logos/Armada-de-Chile.png",
    "/logos/Banco-de-Chile.png",
    "/logos/Coanil.png",
    "/logos/Coca-Cola.png",
    "/logos/Enjoy.png",
    "/logos/Esval.png",
    "/logos/Falabella.png",
    "/logos/FL-Security-and-Service.png",
    "/logos/Freyssinet.png",
    "/logos/Gigante-del-pacifico.png",
    "/logos/Internexa.png",
    "/logos/Marco-Soluciones-Integrales.png",
    "/logos/Mega-Electric-Chile.png",
    "/logos/Pilotes-Terratest.png",
    "/logos/Plaguisur.png",
    "/logos/Salfa.png",
    "/logos/Sence.png",
    "/logos/Ski-Portillo.png",
    "/logos/SMEC.png",
    "/logos/South-Wind.png",
    "/logos/TransGruas.png"
  ],
} = Astro.props;

const isNavy = bg === "navy";
const sectionClasses = isNavy
  ? "bg-[#0b1a33] text-white"
  : "bg-white text-slate-800";
---
<section class={`py-22 ${sectionClasses} font-[Verdana,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif]`}>
  <div class="max-w-7xl mx-auto px-10 md:px-12">
    <header class="text-center mb-8">
      <h2 class="text-2xl md:text-3xl font-bold">{title}</h2>
      <p class={`mt-2 ${isNavy ? "text-white/70" : "text-slate-600"}`}>{subtitle}</p>
    </header>

    <!-- Viewport -->
    <div id="logo-carousel" 
         class="relative overflow-hidden cursor-grab active:cursor-grabbing"
         style="mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent); -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);">

      <!-- Track (duplicado para loop infinito) -->
      <div id="logo-track" 
           class="flex items-center gap-12"
           style={`--speed:${speedSeconds}s`}>
        {logos.map((src: string | null | undefined) => (
          <img src={src} alt="Logo" loading="lazy"
               class={`h-16 md:h-20 object-contain opacity-80 hover:opacity-100 transition-opacity shrink-0 ${isNavy ? "brightness-100" : ""}`}
               draggable="false" />
        ))}
        {logos.map((src: string | null | undefined) => (
          <img src={src} alt="Logo" loading="lazy"
               class={`h-16 md:h-20 object-contain opacity-80 hover:opacity-100 transition-opacity shrink-0 ${isNavy ? "brightness-100" : ""}`}
               draggable="false" />
        ))}
      </div>
    </div>
  </div>
</section>

<script define:vars={{ speedSeconds }}>
  const carousel = document.getElementById('logo-carousel');
  const track = document.getElementById('logo-track');
  
  if (carousel && track) {
    let isDragging = false;
    let startX = 0;
    let scrollLeft = 0;
    let currentTranslate = 0;
    let animationId = null;
    let lastTime = Date.now();
    
    // Calcular velocidad en píxeles por segundo
    const trackWidth = track.scrollWidth / 2; // Mitad porque está duplicado
    const pixelsPerSecond = trackWidth / speedSeconds;
    
    // Animación automática
    function animate() {
      if (!isDragging) {
        const now = Date.now();
        const delta = (now - lastTime) / 1000; // segundos
        lastTime = now;
        
        currentTranslate -= pixelsPerSecond * delta;
        
        // Reset cuando llegamos a la mitad (efecto infinito)
        if (Math.abs(currentTranslate) >= trackWidth) {
          currentTranslate = 0;
        }
        
        track.style.transform = `translateX(${currentTranslate}px)`;
      }
      animationId = requestAnimationFrame(animate);
    }
    
    // Iniciar animación
    animate();
    
    // Pausar al hacer hover
    carousel.addEventListener('mouseenter', () => {
      if (!isDragging) {
        track.style.transition = 'transform 0.3s ease-out';
      }
    });
    
    carousel.addEventListener('mouseleave', () => {
      if (!isDragging) {
        track.style.transition = 'none';
      }
    });
    
    // Eventos de arrastre con mouse
    carousel.addEventListener('mousedown', (e) => {
      isDragging = true;
      startX = e.pageX;
      scrollLeft = currentTranslate;
      track.style.transition = 'none';
      carousel.style.cursor = 'grabbing';
    });
    
    carousel.addEventListener('mouseleave', () => {
      if (isDragging) {
        isDragging = false;
        carousel.style.cursor = 'grab';
        lastTime = Date.now(); // Reset del tiempo para evitar saltos
      }
    });
    
    carousel.addEventListener('mouseup', () => {
      isDragging = false;
      carousel.style.cursor = 'grab';
      lastTime = Date.now(); // Reset del tiempo para evitar saltos
    });
    
    carousel.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      e.preventDefault();
      const x = e.pageX;
      const walk = (x - startX);
      currentTranslate = scrollLeft + walk;
      
      // Normalizar para mantener el loop
      while (currentTranslate > 0) {
        currentTranslate -= trackWidth;
      }
      while (currentTranslate < -trackWidth) {
        currentTranslate += trackWidth;
      }
      
      track.style.transform = `translateX(${currentTranslate}px)`;
    });
    
    // Eventos táctiles para móviles
    carousel.addEventListener('touchstart', (e) => {
      isDragging = true;
      startX = e.touches[0].pageX;
      scrollLeft = currentTranslate;
      track.style.transition = 'none';
    });
    
    carousel.addEventListener('touchend', () => {
      isDragging = false;
      lastTime = Date.now();
    });
    
    carousel.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      const x = e.touches[0].pageX;
      const walk = (x - startX);
      currentTranslate = scrollLeft + walk;
      
      while (currentTranslate > 0) {
        currentTranslate -= trackWidth;
      }
      while (currentTranslate < -trackWidth) {
        currentTranslate += trackWidth;
      }
      
      track.style.transform = `translateX(${currentTranslate}px)`;
    });
  }
</script>

<style>
  #logo-carousel {
    user-select: none;
  }
</style>